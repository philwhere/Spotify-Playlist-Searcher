function GetTimeRemaining(n){const t=Date.parse(n)-Date.parse(new Date),i=Math.floor(t/1e3%60),r=Math.floor(t/6e4%60),u=Math.floor(t/36e5%24),f=Math.floor(t/864e5);return{total:t,days:f,hours:u,minutes:r,seconds:i}}function InitializeClock(n,t){function f(){const n=GetTimeRemaining(t);r.innerHTML=("0"+n.minutes).slice(-2);u.innerHTML=("0"+n.seconds).slice(-2);n.total<=0&&(r.innerHTML="00",u.innerHTML="00")}const i=document.getElementById(n),r=i.querySelector(".minutes"),u=i.querySelector(".seconds");f();GlobalCounting=setInterval(f,1e3)}function ResetClock(n,t){clearInterval(GlobalCounting);InitializeClock(n,t)}function Search(){const n=$("#searchbar").val().trim();if(!_.isEmpty(n)){const t=GetPlaylistMatches(n);ShowResults(t);ListenForRemoveClicks()}}function GetPlaylistMatches(n){function t(t){return Object.assign({},t,{songs:Object.assign({},t.songs,{items:t.songs.items.filter(t=>GetMatch(t.track,n))})})}return GlobalPlaylists.map(n=>t(n)).filter(n=>!_.isEmpty(n.songs.items))}function ShowResults(n){$("#tableBody").empty();for(const n of n){const t=ConstructRow(n);$("#tableBody").append(t)}n.length>0&&$("#tablePanel").removeClass("hidden")}function ConstructRow(n){const t=n.songs.items;let i=`<tr><td class="text-center">${n.name}</td>`;const r=t.reduce((n,t)=>`${n}<p>${t.track.artistsString}</p>`,""),u=t.reduce((t,i)=>`${t}<p class="song" playlistId="${n.id}" uri="${i.track.uri}">${i.track.name}</p>`,"");return i+`<td>${r}</td><td>${u}</td></tr>`}function GetMatch(n,t){return $("#selectedSearchOption").text().includes("Song")?PartialMatch(n.name,t):$("#selectedSearchOption").text().includes("Artist")?PartialMatch(n.artistsString,t):PartialMatch(n.name,t)||PartialMatch(n.artistsString,t)}function PartialMatch(n,t){return n.toLowerCase().includes(t.toLowerCase())}function TriggerRemoval(n,t){const i=GlobalPlaylists.find(t=>t.id===n),r=i.songs.items.find(n=>n.track.uri===t).track,u=confirm(`Do you want to remove "${r.name}" by "${r.artistsString}" from "${i.name}"?`);u&&RemoveFromServer(RemoveSongFromLocal,n,t)}function RemoveFromServer(n,t,i){$.ajax({url:`/api/spotify/playlists/${t}/tracks/${i}`,type:"delete",headers:{Authorization:`Bearer ${GlobalAccesssToken}`},beforeSend:function(){ShowLoader()}}).always(function(){HideLoader()}).fail(function(){alert("Delete exploded")}).done(function(){n(t,i)})}function RemoveSongFromLocal(n,t){const i=GlobalPlaylists.findIndex(t=>t.id===n);_.remove(GlobalPlaylists[i].songs.items,n=>n.track.uri===t);Search()}function GetNewAuthByRefreshToken(n){$.ajax({url:`/api/spotify/token?refresh_token=${GlobalUrlParams.get("refresh_token")}`,type:"get",beforeSend:function(){ShowLoader()}}).always(function(){HideLoader()}).fail(function(){alert("Refresh exploded")}).done(function(t){const i=CalculateUnixInMsExpiry(t.expires_in);n(t.access_token,i)})}function UpdateClockAndAccessToken(n,t){ResetClock("clockdiv",new Date(t));GlobalAccesssToken=n}function UpdatePageWithNewAccess(n,t){GlobalUrlParams.set("access_token",n);GlobalUrlParams.set("expiry",t);ShowLoader();window.location.search=GlobalUrlParams.toString()}function ListenForRemoveClicks(){$(".song").click(function(){const n=$(this).attr("playlistId"),t=$(this).attr("uri");TriggerRemoval(n,t)})}function LoadInitialClock(){const n=parseInt(GlobalUrlParams.get("expiry"));InitializeClock("clockdiv",new Date(n))}var GlobalCounting,GlobalAccesssToken=GlobalUrlParams.get("access_token");$(document).ready(function(){LoadInitialClock();$("#searchbar").keyup(()=>Search());$("#searchOptions li").click(n=>{const t=n.currentTarget.innerText;$("#selectedSearchOption").html(`${t} <span class="caret"></span>`);Search()});$("#refreshDataButton").click(()=>GetNewAuthByRefreshToken(UpdatePageWithNewAccess));$("#refreshTokenButton").click(()=>GetNewAuthByRefreshToken(UpdateClockAndAccessToken))});