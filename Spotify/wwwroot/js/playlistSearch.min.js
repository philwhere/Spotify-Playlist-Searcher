function GetTimeRemaining(endtime){const t=Date.parse(endtime)-Date.parse(new Date),seconds=Math.floor(t/1e3%60),minutes=Math.floor(t/6e4%60),hours=Math.floor(t/36e5%24),days=Math.floor(t/864e5);return{total:t,days:days,hours:hours,minutes:minutes,seconds:seconds}}function InitializeClock(id,endTime){function UpdateClock(){const t=GetTimeRemaining(endTime),minutes=("0"+t.minutes).slice(-2),seconds=("0"+t.seconds).slice(-2);countdownDisplaySpan.innerHTML=`${minutes}:${seconds}`;t.total<=0&&(countdownDisplaySpan.innerHTML="00:00")}const clock=document.getElementById(id),countdownDisplaySpan=clock.querySelector(".countdownDisplay");UpdateClock();GlobalCounting=setInterval(UpdateClock,1e3)}function ResetClock(id,endTime){clearInterval(GlobalCounting);InitializeClock(id,endTime)}function Search(){const query=$("#searchbar").val().trim();if(!_.isEmpty(query)){const playlistMatches=GetPlaylistMatches(query);ShowResults(playlistMatches);ListenForRemoveClicks()}}function GetPlaylistMatches(query){function ExcludeNonMatchingSongs(playlist){return Object.assign({},playlist,{songs:Object.assign({},playlist.songs,{items:playlist.songs.items.filter(s=>GetMatch(s.track,query))})})}return GlobalPlaylists.map(playlist=>ExcludeNonMatchingSongs(playlist)).filter(p=>!_.isEmpty(p.songs.items))}function ShowResults(playlistMatches){$("#tableBody").empty();for(const playlist of playlistMatches){const row=ConstructRow(playlist);$("#tableBody").append(row)}playlistMatches.length>0&&$("#tablePanel").removeClass("hidden")}function ConstructRow(playlist){const songs=playlist.songs.items;let row=`<tr><td class="text-center">${playlist.name}</td>`;const artists=songs.reduce((prev,song)=>`${prev}<p>${song.track.artistsString}</p>`,""),tracks=songs.reduce((prev,song)=>`${prev}<p class="song" playlistId="${playlist.id}" uri="${song.track.uri}">${song.track.name}</p>`,"");return row+`<td>${artists}</td><td>${tracks}</td></tr>`}function GetMatch(track,query){return $("#selectedSearchOption").text().includes("Song")?PartialMatch(track.name,query):$("#selectedSearchOption").text().includes("Artist")?PartialMatch(track.artistsString,query):PartialMatch(track.name,query)||PartialMatch(track.artistsString,query)}function PartialMatch(type,query){return type.toLowerCase().includes(query.toLowerCase())}function TriggerRemoval(playlistId,songUri){const playlist=GlobalPlaylists.find(p=>p.id===playlistId),track=playlist.songs.items.find(s=>s.track.uri===songUri).track,confirmed=confirm(`Do you want to remove "${track.name}" by "${track.artistsString}" from "${playlist.name}"?`);confirmed&&RemoveFromServer(RemoveSongFromLocal,playlistId,songUri)}function RemoveFromServer(callback,playlistId,songUri){$.ajax({url:`/api/spotify/playlists/${playlistId}/tracks/${songUri}`,type:"delete",headers:{Authorization:`Bearer ${GlobalAccesssToken}`},beforeSend:function(){ShowLoader()}}).always(function(){HideLoader()}).fail(function(){alert("Delete exploded")}).done(function(){callback(playlistId,songUri)})}function RemoveSongFromLocal(playlistId,songUri){const playlistIndex=GlobalPlaylists.findIndex(p=>p.id===playlistId);_.remove(GlobalPlaylists[playlistIndex].songs.items,s=>s.track.uri===songUri);Search()}function GetNewAuthByRefreshToken(callback){$.ajax({url:`/api/spotify/token?refresh_token=${GlobalUrlParams.get("refresh_token")}`,type:"get",beforeSend:function(){ShowLoader()}}).always(function(){HideLoader()}).fail(function(){alert("Refresh exploded")}).done(function(response){const expiry=CalculateUnixInMsExpiry(response.expires_in);callback(response.access_token,expiry)})}function UpdateClockAndAccessToken(accessToken,expiry){ResetClock("clockdiv",new Date(expiry));GlobalAccesssToken=accessToken}function UpdatePageWithNewAccess(accessToken,expiry){GlobalUrlParams.set("access_token",accessToken);GlobalUrlParams.set("expiry",expiry);ShowLoader();window.location.search=GlobalUrlParams.toString()}function ListenForRemoveClicks(){$(".song").click(function(){const playlistId=$(this).attr("playlistId"),songUri=$(this).attr("uri");TriggerRemoval(playlistId,songUri)})}function LoadInitialClock(){const sessionExpiry=parseInt(GlobalUrlParams.get("expiry"));InitializeClock("clockdiv",new Date(sessionExpiry))}var GlobalCounting,GlobalAccesssToken=GlobalUrlParams.get("access_token");$(document).ready(function(){LoadInitialClock();$("#searchbar").keyup(()=>Search());$("#searchOptions li").click(e=>{const selectedOption=e.currentTarget.innerText;$("#selectedSearchOption").html(`${selectedOption} <span class="caret"></span>`);Search()});$("#refreshDataButton").click(()=>GetNewAuthByRefreshToken(UpdatePageWithNewAccess));$("#refreshTokenButton").click(()=>GetNewAuthByRefreshToken(UpdateClockAndAccessToken))});